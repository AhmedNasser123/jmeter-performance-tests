name: JMeter Performance Test with Email Link

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  JMETER_VERSION: '5.6.3'
  TEST_PLAN_PATH: 'google-test-.jmx'
  RP_PROJECT: 'google-test-'
  RECIPIENT_EMAIL: 'aahmeed.naabeel@gmail.com'  # âš ï¸ ØºÙŠØ± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù‡Ù†Ø§

jobs:
  performance-test:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: ğŸ’¾ Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v3
      with:
        path: apache-jmeter-${{ env.JMETER_VERSION }}
        key: jmeter-${{ env.JMETER_VERSION }}

    - name: ğŸ“¥ Download JMeter
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "ğŸ“¥ Downloading JMeter $env:JMETER_VERSION..."
        $url = "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-$env:JMETER_VERSION.zip"
        Invoke-WebRequest -Uri $url -OutFile "jmeter.zip"
        
        Write-Host "ğŸ“‚ Extracting JMeter..."
        Expand-Archive -Path jmeter.zip -DestinationPath . -Force
        Remove-Item jmeter.zip
        
        Write-Host "âœ… JMeter ready!"

    - name: ğŸ§ª Run JMeter Performance Test
      shell: pwsh
      run: |
        $jmeterPath = "apache-jmeter-$env:JMETER_VERSION\bin\jmeter.bat"
        $testPlan = $env:TEST_PLAN_PATH
        
        Write-Host "ğŸš€ Starting Performance Test..."
        Write-Host "Test Plan: $testPlan"
        
        if (-not (Test-Path $testPlan)) {
            Write-Host "âŒ ERROR: Test plan not found at: $testPlan"
            exit 1
        }
        
        & $jmeterPath -n -t $testPlan -l results.jtl -e -o html-report -j jmeter.log
        
        if (Test-Path "results.jtl") {
            Write-Host "âœ… Results file created"
        }
        
        if (Test-Path "html-report\index.html") {
            Write-Host "âœ… HTML report created"
        }

    - name: ğŸ“Š Generate Test Summary & Email Content
      if: always()
      shell: pwsh
      run: |
        # Ø¨Ù†Ø§Ø¡ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù€ Artifacts ÙˆØ§Ù„Ù€ Workflow
        $workflowUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        $artifactsUrl = "$workflowUrl#artifacts"
        
        Write-Host "ğŸ”— Workflow URL: $workflowUrl"
        Write-Host "ğŸ”— Artifacts URL: $artifactsUrl"
        
        if (-not (Test-Path "results.jtl")) {
            @"
        <!DOCTYPE html>
        <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
            .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .link-button { display: inline-block; margin: 10px 5px; padding: 12px 25px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px; font-weight: bold; }
            .link-button:hover { background: #1976D2; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1 style="color: red;">âŒ Test Failed</h1>
            <p>No results were generated. Please check the workflow logs.</p>
            <a href="$workflowUrl" class="link-button">View Logs</a>
          </div>
        </body>
        </html>
        "@ | Out-File -FilePath "email-report.html" -Encoding utf8
            "failed" | Out-File -FilePath "test-status.txt"
            exit 0
        }
        
        $content = Get-Content "results.jtl"
        if ($content.Count -le 1) {
            @"
        <!DOCTYPE html>
        <html>
        <head>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
            .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; padding: 30px; }
          </style>
        </head>
        <body>
          <div class="container">
            <h1 style="color: orange;">âš ï¸ No Results</h1>
            <p>Test ran but produced no results.</p>
          </div>
        </body>
        </html>
        "@ | Out-File -FilePath "email-report.html" -Encoding utf8
            "no-results" | Out-File -FilePath "test-status.txt"
            exit 0
        }
        
        # Calculate metrics
        $totalSamples = $content.Count - 1
        $results = $content | Select-Object -Skip 1 | ForEach-Object {
            $fields = $_ -split ','
            if ($fields.Count -ge 8) {
                [PSCustomObject]@{
                    Success = $fields[7] -eq 'true'
                    ResponseTime = if ($fields[1]) { [int]$fields[1] } els
