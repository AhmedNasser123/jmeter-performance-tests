name: JMeter Performance Test with Email Report

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  JMETER_VERSION: '5.6.3'
  TEST_PLAN_PATH: 'google-test-.jmx'
  RP_PROJECT: 'google-test-'
  RECIPIENT_EMAIL: 'aahmeed.naabeel@gmail.com'  # ‚ö†Ô∏è ÿ∫Ÿäÿ± ÿßŸÑÿ•ŸäŸÖŸäŸÑ ŸáŸÜÿß

jobs:
  performance-test:
    runs-on: windows-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4

    - name: ‚òï Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: üíæ Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v3
      with:
        path: apache-jmeter-${{ env.JMETER_VERSION }}
        key: jmeter-${{ env.JMETER_VERSION }}

    - name: üì• Download JMeter
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "üì• Downloading JMeter $env:JMETER_VERSION..."
        $url = "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-$env:JMETER_VERSION.zip"
        Invoke-WebRequest -Uri $url -OutFile "jmeter.zip"
        
        Write-Host "üìÇ Extracting JMeter..."
        Expand-Archive -Path jmeter.zip -DestinationPath . -Force
        Remove-Item jmeter.zip
        
        Write-Host "‚úÖ JMeter ready!"

    - name: üß™ Run JMeter Performance Test
      shell: pwsh
      run: |
        $jmeterPath = "apache-jmeter-$env:JMETER_VERSION\bin\jmeter.bat"
        $testPlan = $env:TEST_PLAN_PATH
        
        Write-Host "üöÄ Starting Performance Test..."
        Write-Host "Test Plan: $testPlan"
        
        if (-not (Test-Path $testPlan)) {
            Write-Host "‚ùå ERROR: Test plan not found at: $testPlan"
            exit 1
        }
        
        & $jmeterPath -n -t $testPlan -l results.jtl -e -o html-report -j jmeter.log
        
        if (Test-Path "results.jtl") {
            Write-Host "‚úÖ Results file created"
        }
        
        if (Test-Path "html-report\index.html") {
            Write-Host "‚úÖ HTML report created"
        }

    - name: üìä Generate Test Summary & Email Content
      if: always()
      shell: pwsh
      run: |
        if (-not (Test-Path "results.jtl")) {
            @"
        <!DOCTYPE html>
        <html>
        <body style="font-family: Arial, sans-serif; padding: 20px;">
          <h1 style="color: red;">‚ùå Test Failed</h1>
          <p>No results were generated. Please check the workflow logs.</p>
          <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
             style="display: inline-block; padding: 10px 20px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px;">
            View Logs
          </a>
        </body>
        </html>
        "@ | Out-File -FilePath "email-report.html" -Encoding utf8
            exit 0
        }
        
        $content = Get-Content "results.jtl"
        if ($content.Count -le 1) {
            @"
        <!DOCTYPE html>
        <html>
        <body style="font-family: Arial, sans-serif; padding: 20px;">
          <h1 style="color: orange;">‚ö†Ô∏è No Results</h1>
          <p>Test ran but produced no results.</p>
        </body>
        </html>
        "@ | Out-File -FilePath "email-report.html" -Encoding utf8
            exit 0
        }
        
        # Calculate metrics
        $totalSamples = $content.Count - 1
        $results = $content | Select-Object -Skip 1 | ForEach-Object {
            $fields = $_ -split ','
            if ($fields.Count -ge 8) {
                [PSCustomObject]@{
                    Success = $fields[7] -eq 'true'
                    ResponseTime = if ($fields[1]) { [int]$fields[1] } else { 0 }
                }
            }
        }
        
        $successful = ($results | Where-Object { $_.Success }).Count
        $failed = ($results | Where-Object { -not $_.Success }).Count
        $successRate = [math]::Round(($successful/$totalSamples)*100, 2)
        $avgTime = [math]::Round(($results | Measure-Object -Property ResponseTime -Average).Average, 2)
        $maxTime = ($results | Measure-Object -Property ResponseTime -Maximum).Maximum
        $minTime = ($results | Measure-Object -Property ResponseTime -Minimum).Minimum
        
        $statusColor = if ($successRate -ge 95) { "#4CAF50" } elseif ($successRate -ge 80) { "#FF9800" } else { "#F44336" }
        $statusIcon = if ($successRate -ge 95) { "‚úÖ" } elseif ($successRate -ge 80) { "‚ö†Ô∏è" } else { "‚ùå" }
        
        # Generate HTML email
        @"
        <!DOCTYPE html>
        <html>
        <head>
          <style>
            body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
            .container { max-width: 600px; margin: 20px auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .header { background: $statusColor; color: white; padding: 30px; text-align: center; }
            .header h1 { margin: 0; font-size: 28px; }
            .content { padding: 30px; }
            .metric { display: flex; justify-content: space-between; padding: 15px; margin: 10px 0; background: #f9f9f9; border-radius: 5px; border-left: 4px solid $statusColor; }
            .metric-label { font-weight: bold; color: #666; }
            .metric-value { font-size: 18px; color: #333; font-weight: bold; }
            .footer { background: #f5f5f5; padding: 20px; text-align: center; color: #666; font-size: 12px; }
            .link { display: inline-block; margin: 20px 0; padding: 12px 30px; background: #2196F3; color: white; text-decoration: none; border-radius: 5px; }
          </style>
        </head>
        <body>
          <div class="container">
            <div class="header">
              <h1>$statusIcon Performance Test Report</h1>
              <p>Run #${{ github.run_number }} - ${{ github.ref_name }}</p>
            </div>
            <div class="content">
              <h2>üìä Test Results</h2>
              
              <div class="metric">
                <span class="metric-label">üìù Total Requests</span>
                <span class="metric-value">$totalSamples</span>
              </div>
              
              <div class="metric">
                <span class="metric-label">‚úÖ Successful</span>
                <span class="metric-value">$successful</span>
              </div>
              
              <div class="metric">
                <span class="metric-label">‚ùå Failed</span>
                <span class="metric-value">$failed</span>
              </div>
              
              <div class="metric">
                <span class="metric-label">üìà Success Rate</span>
                <span class="metric-value" style="color: $statusColor;">$successRate%</span>
              </div>
              
              <div class="metric">
                <span class="metric-label">‚è±Ô∏è Avg Response Time</span>
                <span class="metric-value">$avgTime ms</span>
              </div>
              
              <div class="metric">
                <span class="metric-label">‚ö° Min Response Time</span>
                <span class="metric-value">$minTime ms</span>
              </div>
              
              <div class="metric">
                <span class="metric-label">üî• Max Response Time</span>
                <span class="metric-value">$maxTime ms</span>
              </div>
              
              <div style="text-align: center;">
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="link">
                  View Full Report & Download HTML
                </a>
              </div>
              
              <p style="margin-top: 20px; padding: 15px; background: #E3F2FD; border-radius: 5px;">
                <strong>üì• Note:</strong> The complete HTML report with detailed graphs and statistics is attached to this email as a ZIP file.
              </p>
            </div>
            <div class="footer">
              <p><strong>Repository:</strong> ${{ github.repository }}</p>
              <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
              <p><strong>Triggered by:</strong> ${{ github.actor }}</p>
              <p><strong>Commit:</strong> ${{ github.sha }}</p>
            </div>
          </div>
        </body>
        </html>
        "@ | Out-File -FilePath "email-report.html" -Encoding utf8
        
        Write-Host "‚úÖ Email report generated"
        Write-Host "================================"
        Write-Host "üìä TEST SUMMARY"
        Write-Host "================================"
        Write-Host "Total Requests: $totalSamples"
        Write-Host "Successful: $successful"
        Write-Host "Failed: $failed"
        Write-Host "Success Rate: $successRate%"
        Write-Host "Avg Response Time: $avgTime ms"
        Write-Host "================================"

    - name: üì¶ Zip HTML Report for Email
      if: always()
      shell: pwsh
      run: |
        if (Test-Path "html-report") {
            Compress-Archive -Path "html-report\*" -DestinationPath "jmeter-report.zip" -Force
            Write-Host "‚úÖ HTML report zipped for email attachment"
            $size = (Get-Item "jmeter-report.zip").Length / 1MB
            Write-Host "Report size: $([math]::Round($size, 2)) MB"
        }

    - name: üìß Send Email Report
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "${{ env.RP_PROJECT }} Performance Test - Run #${{ github.run_number }}"
        to: ${{ env.RECIPIENT_EMAIL }}
        from: JMeter Bot <${{ secrets.EMAIL_USERNAME }}>
        html_body: file://email-report.html
        attachments: jmeter-report.zip
        priority: normal

    - name: üì¶ Upload HTML Report (GitHub Artifacts)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: html-report
        path: html-report/
        retention-days: 30
        if-no-files-found: warn

    - name: üì¶ Upload JTL Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jtl-results
        path: results.jtl
        retention-days: 30
        if-no-files-found: warn

    - name: üì¶ Upload JMeter Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-logs
        path: jmeter.log
        retention-days: 30
        if-no-files-found: warn
