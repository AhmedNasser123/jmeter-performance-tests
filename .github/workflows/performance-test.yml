name: JMeter Performance Test with Email Link

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  JMETER_VERSION: '5.6.3'
  TEST_PLAN_PATH: 'google-test-.jmx'
  RP_PROJECT: 'google-test-'
  RECIPIENT_EMAIL: 'aahmeed.naabeel@gmail.com'

jobs:
  performance-test:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: â˜• Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: ğŸ’¾ Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v3
      with:
        path: apache-jmeter-${{ env.JMETER_VERSION }}
        key: jmeter-${{ env.JMETER_VERSION }}

    - name: ğŸ“¥ Download JMeter
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "ğŸ“¥ Downloading JMeter $env:JMETER_VERSION..."
        $url = "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-$env:JMETER_VERSION.zip"
        Invoke-WebRequest -Uri $url -OutFile "jmeter.zip"
        
        Write-Host "ğŸ“‚ Extracting JMeter..."
        Expand-Archive -Path jmeter.zip -DestinationPath . -Force
        Remove-Item jmeter.zip
        
        Write-Host "âœ… JMeter ready!"

    - name: ğŸ§ª Run JMeter Performance Test
      shell: pwsh
      run: |
        $jmeterPath = "apache-jmeter-$env:JMETER_VERSION\bin\jmeter.bat"
        $testPlan = $env:TEST_PLAN_PATH
        
        Write-Host "ğŸš€ Starting Performance Test..."
        Write-Host "Test Plan: $testPlan"
        
        if (-not (Test-Path $testPlan)) {
            Write-Host "âŒ ERROR: Test plan not found at: $testPlan"
            exit 1
        }
        
        & $jmeterPath -n -t $testPlan -l results.jtl -e -o html-report -j jmeter.log
        
        if (Test-Path "results.jtl") {
            Write-Host "âœ… Results file created"
        }
        
        if (Test-Path "html-report\index.html") {
            Write-Host "âœ… HTML report created"
        }

    - name: ğŸ“Š Generate Test Summary & Email Content
      if: always()
      shell: pwsh
      run: |
        $workflowUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        $artifactsUrl = "$workflowUrl#artifacts"
        
        Write-Host "ğŸ”— Workflow URL: $workflowUrl"
        Write-Host "ğŸ”— Artifacts URL: $artifactsUrl"
        
       
        
        Write-Host "âœ… Email report generated"
        Write-Host "================================"
        Write-Host "ğŸ“Š TEST SUMMARY"
        Write-Host "================================"
        Write-Host "Total Requests: $totalSamples"
        Write-Host "Successful: $successful"
        Write-Host "Failed: $failed"
        Write-Host "Success Rate: $successRate%"
        Write-Host "Avg Response Time: $avgTime ms"
        Write-Host "================================"

    - name: ğŸ“§ Send Email Report with Artifacts Link
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "${{ env.RP_PROJECT }} Performance Test - Run #${{ github.run_number }}"
        to: ${{ env.RECIPIENT_EMAIL }}
        from: JMeter Bot <${{ secrets.EMAIL_USERNAME }}>
        html_body: file://email-report.html
        priority: normal
        ignore_cert: true
        convert_markdown: false

    - name: ğŸ“¦ Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: html-report
        path: html-report/
        retention-days: 30
        if-no-files-found: warn

    - name: ğŸ“¦ Upload JTL Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jtl-results
        path: results.jtl
        retention-days: 30
        if-no-files-found: warn

    - name: ğŸ“¦ Upload JMeter Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-logs
        path: jmeter.log
        retention-days: 30
        if-no-files-found: warn

    - name: âœ… Print Summary
      if: always()
      shell: pwsh
      run: |
        $workflowUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        $artifactsUrl = "$workflowUrl#artifacts"
        
        Write-Host "================================"
        Write-Host "ğŸ“§ EMAIL SENT SUCCESSFULLY"
        Write-Host "================================"
        Write-Host "ğŸ”— Artifacts URL: $artifactsUrl"
        Write-Host "ğŸ”— Workflow URL: $workflowUrl"
        Write-Host ""
        Write-Host "ğŸ“¦ Recipients will receive:"
        Write-Host "  - Test summary with metrics"
        Write-Host "  - Direct link to download artifacts"
        Write-Host "  - Instructions for viewing reports"
        Write-Host "================================"
