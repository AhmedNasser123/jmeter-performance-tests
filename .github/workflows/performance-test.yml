name: JMeter Performance Test

# Ù…ØªÙ‰ ÙŠØ´ØªØºÙ„
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
  workflow_dispatch:  # Ø¹Ø´Ø§Ù† ØªÙ‚Ø¯Ø± ØªØ´ØºÙ„Ù‡ ÙŠØ¯ÙˆÙŠ

# Variables Ø¹Ø§Ù…Ø©
env:
  JMETER_VERSION: '5.6.3'
  TEST_PLAN_PATH: 'jmeter-performance-tests/google-test-.jmx'  # âš ï¸ ØºÙŠØ± Ø§Ù„Ø§Ø³Ù…
#RP_ENDPOINT: 'http://your-reportportal-url'             # âš ï¸ ØºÙŠØ± Ø§Ù„Ù€ URL
  RP_PROJECT: 'google-test-'                         # âš ï¸ ØºÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù€ Project

jobs:
  performance-test:
    runs-on: windows-latest
    
    steps:
    # Step 1: Checkout Ø§Ù„ÙƒÙˆØ¯
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    # Step 2: Setup Java
    - name: â˜• Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    # Step 3: Cache JMeter (Ø¹Ø´Ø§Ù† Ù…ÙŠØ­Ù…Ù„Ø´ ÙƒÙ„ Ù…Ø±Ø©)
    - name: ğŸ’¾ Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v3
      with:
        path: apache-jmeter-${{ env.JMETER_VERSION }}
        key: jmeter-${{ env.JMETER_VERSION }}

    # Step 4: Download JMeter (Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Cache)
    - name: ğŸ“¥ Download JMeter
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "ğŸ“¥ Downloading JMeter $env:JMETER_VERSION..."
        $url = "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-$env:JMETER_VERSION.zip"
        Invoke-WebRequest -Uri $url -OutFile "jmeter.zip"
        
        Write-Host "ğŸ“‚ Extracting JMeter..."
        Expand-Archive -Path jmeter.zip -DestinationPath . -Force
        Remove-Item jmeter.zip
        
        Write-Host "âœ… JMeter downloaded!"

    # Step 5: Download ReportPortal Plugin
    # - name: ğŸ“¥ Download ReportPortal Plugin
     #   shell: pwsh
    #    run: |
      #    Write-Host "ğŸ“¥ Downloading ReportPortal Plugin..."
      #    $pluginUrl = "https://github.com/reportportal/agent-java-jmeter/releases/latest/download/agent-java-jmeter.jar"
   #       $pluginPath = "apache-jmeter-$env:JMETER_VERSION\lib\ext\agent-java-jmeter.jar"
         
      #    try {
     #        Invoke-WebRequest -Uri $pluginUrl -OutFile $pluginPath
      #        Write-Host "âœ… ReportPortal plugin installed!"
      #    } catch {
      #        Write-Host "âš ï¸ Could not download plugin: $_"
     #     }
     #   continue-on-error: true

    # Step 6: Run JMeter Test
    - name: ğŸ§ª Run JMeter Performance Test
      shell: pwsh
      run: |
        $jmeterPath = "apache-jmeter-$env:JMETER_VERSION\bin\jmeter.bat"

        Write-Host "ğŸš€ Starting Performance Test..."
        Write-Host "Test Plan: $env:TEST_PLAN_PATH"
       
        
        & $jmeterPath -n `
          -t $env:TEST_PLAN_PATH `
          -l results.jtl `
          -e `
          -o html-report `
          -j jmeter.log `
          
        
        if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Test completed successfully!"
        } else {
            Write-Host "âš ï¸ Test completed with warnings"
        }
      continue-on-error: true

    # Step 7: Generate Test Summary
    - name: ğŸ“Š Generate Test Summary
      if: always()
      shell: pwsh
      run: |
        if (Test-Path "results.jtl") {
            $content = Get-Content "results.jtl"
            $totalSamples = $content.Count - 1
            
            # Parse results Ù„Ù„Ù€ summary
            $results = $content | Select-Object -Skip 1 | ForEach-Object {
                $fields = $_ -split ','
                [PSCustomObject]@{
                    Success = $fields[7] -eq 'true'
                    ResponseTime = [int]$fields[1]
                }
            }
            
            $successful = ($results | Where-Object { $_.Success }).Count
            $failed = ($results | Where-Object { -not $_.Success }).Count
            $avgTime = ($results | Measure-Object -Property ResponseTime -Average).Average
            $maxTime = ($results | Measure-Object -Property ResponseTime -Maximum).Maximum
            $minTime = ($results | Measure-Object -Property ResponseTime -Minimum).Minimum
            
            # Create summary Ù„Ù„Ù€ GitHub
            $summary = @"
        ## ğŸ“Š Performance Test Results
        
        | Metric | Value |
        |--------|-------|
        | ğŸ“ Total Requests | $totalSamples |
        | âœ… Successful | $successful |
        | âŒ Failed | $failed |
        | ğŸ“ˆ Success Rate | $([math]::Round(($successful/$totalSamples)*100, 2))% |
        | â±ï¸ Avg Response Time | $([math]::Round($avgTime, 2)) ms |
        | âš¡ Min Response Time | $minTime ms |
        | ğŸ”¥ Max Response Time | $maxTime ms |
        
        ### ğŸ”— Links
        - [HTML Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        - [ReportPortal]($env:RP_ENDPOINT)
        "@
            
            $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
            
            Write-Host "================================"
            Write-Host "ğŸ“Š TEST SUMMARY"
            Write-Host "================================"
            Write-Host "Total Requests: $totalSamples"
            Write-Host "Successful: $successful"
            Write-Host "Failed: $failed"
            Write-Host "Success Rate: $([math]::Round(($successful/$totalSamples)*100, 2))%"
            Write-Host "Avg Response Time: $([math]::Round($avgTime, 2)) ms"
            Write-Host "================================"
        }

    # Step 8: Upload HTML Report
    - name: ğŸ“¦ Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: html-report
        path: html-report/
        retention-days: 30

    # Step 9: Upload JTL Results
    - name: ğŸ“¦ Upload JTL Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jtl-results
        path: results.jtl
        retention-days: 30

    # Step 10: Upload JMeter Logs
    - name: ğŸ“¦ Upload JMeter Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-logs
        path: jmeter.log
        retention-days: 30

    # Step 11: Deploy HTML Report to GitHub Pages (Optional)
  #  - name: ğŸŒ Deploy to GitHub Pages
  #    if: always() && github.ref == 'refs/heads/main'
   #   uses: peaceiris/actions-gh-pages@v3
  #    with:
     #   github_token: ${{ secrets.GITHUB_TOKEN }}
    #    publish_dir: ./html-report
   #     destination_dir: reports/${{ github.run_number }}
#
    # Step 12: Comment on PR with results (Ù„Ùˆ ÙƒØ§Ù† PR)
    - name: ğŸ’¬ Comment Test Results on PR
      if: always() && github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('results.jtl')) {
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
          }
