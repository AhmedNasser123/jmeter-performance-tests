name: JMeter Performance Test with Email Link

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  JMETER_VERSION: '5.6.3'
  TEST_PLAN_PATH: 'google-test-.jmx'
  RP_PROJECT: 'google-test-'
  RECIPIENT_EMAIL: 'aahmeed.naabeel@gmail.com'

jobs:
  performance-test:
    runs-on: windows-latest
    
    steps:
    - name: üì• Checkout Repository
      uses: actions/checkout@v4

    - name: ‚òï Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: üíæ Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v3
      with:
        path: apache-jmeter-${{ env.JMETER_VERSION }}
        key: jmeter-${{ env.JMETER_VERSION }}

    - name: üì• Download JMeter
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "üì• Downloading JMeter $env:JMETER_VERSION..."
        $url = "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-$env:JMETER_VERSION.zip"
        Invoke-WebRequest -Uri $url -OutFile "jmeter.zip"
        
        Write-Host "üìÇ Extracting JMeter..."
        Expand-Archive -Path jmeter.zip -DestinationPath . -Force
        Remove-Item jmeter.zip
        
        Write-Host "‚úÖ JMeter ready!"

    - name: üß™ Run JMeter Performance Test
      shell: pwsh
      run: |
        $jmeterPath = "apache-jmeter-$env:JMETER_VERSION\bin\jmeter.bat"
        $testPlan = $env:TEST_PLAN_PATH
        
        Write-Host "üöÄ Starting Performance Test..."
        Write-Host "Test Plan: $testPlan"
        
        if (-not (Test-Path $testPlan)) {
            Write-Host "‚ùå ERROR: Test plan not found at: $testPlan"
            exit 1
        }
        
        & $jmeterPath -n -t $testPlan -l results.jtl -e -o html-report -j jmeter.log
        
        if (Test-Path "results.jtl") {
            Write-Host "‚úÖ Results file created"
        }
        
        if (Test-Path "html-report\index.html") {
            Write-Host "‚úÖ HTML report created"
        }

    - name: üìä Generate Test Summary & Email Content
      if: always()
      shell: pwsh
      run: |
        $workflowUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        $artifactsUrl = "$workflowUrl#artifacts"
        
        Write-Host "üîó Workflow URL: $workflowUrl"
        Write-Host "üîó Artifacts URL: $artifactsUrl"
        
        # Parse JTL results
        $totalSamples = 0
        $successful = 0
        $failed = 0
        $totalTime = 0
        
        if (Test-Path "results.jtl") {
            $content = Get-Content "results.jtl"
            $lines = $content | Select-Object -Skip 1
            
            foreach ($line in $lines) {
                if ($line.Trim()) {
                    $totalSamples++
                    $fields = $line -split ','
                    if ($fields.Count -gt 7) {
                        $elapsed = [int]$fields[1]
                        $success = $fields[7]
                        $totalTime += $elapsed
                        
                        if ($success -eq 'true') {
                            $successful++
                        } else {
                            $failed++
                        }
                    }
                }
            }
        }
        
        $successRate = if ($totalSamples -gt 0) { [math]::Round(($successful / $totalSamples) * 100, 2) } else { 0 }
        $avgTime = if ($totalSamples -gt 0) { [math]::Round($totalTime / $totalSamples, 2) } else { 0 }
        
        $currentDate = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        $runNumber = "${{ github.run_number }}"
        $repository = "${{ github.repository }}"
        
        # Create HTML email report
        $htmlContent = @"
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 10px; text-align: center; }
        .summary { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #667eea; }
        .metric { display: inline-block; margin: 10px 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .metric-label { font-size: 12px; color: #666; text-transform: uppercase; }
        .metric-value { font-size: 24px; font-weight: bold; color: #667eea; }
        .success { color: #28a745; }
        .failed { color: #dc3545; }
        .button { display: inline-block; padding: 12px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin: 10px 5px; }
        .button:hover { background: #764ba2; }
        .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ JMeter Performance Test Report</h1>
        <p><strong>$env:RP_PROJECT</strong> - Run #$runNumber</p>
        <p>Run Date: $currentDate</p>
    </div>
    
    <div class="summary">
        <h2>üìä Test Summary</h2>
        <div class="metric">
            <div class="metric-label">Total Requests</div>
            <div class="metric-value">$totalSamples</div>
        </div>
        <div class="metric">
            <div class="metric-label">Successful</div>
            <div class="metric-value success">$successful</div>
        </div>
        <div class="metric">
            <div class="metric-label">Failed</div>
            <div class="metric-value failed">$failed</div>
        </div>
        <div class="metric">
            <div class="metric-label">Success Rate</div>
            <div class="metric-value">$successRate%</div>
        </div>
        <div class="metric">
            <div class="metric-label">Avg Response Time</div>
            <div class="metric-value">$avgTime ms</div>
        </div>
    </div>
    
    <div style="text-align: center; margin: 30px 0;">
        <h3>üì¶ Download Test Artifacts</h3>
        <p>Click the button below to access the full HTML report and test results:</p>
        <a href="$artifactsUrl" class="button">üì• Download Artifacts</a>
        <a href="$workflowUrl" class="button">üîó View Workflow Details</a>
    </div>
    
    <div class="summary">
        <h3>üìã How to View the Report</h3>
        <ol>
            <li>Click the "Download Artifacts" button above</li>
            <li>Download the <strong>html-report</strong> artifact</li>
            <li>Extract the ZIP file</li>
            <li>Open <strong>index.html</strong> in your browser</li>
        </ol>
    </div>
    
    <div class="footer">
        <p>Generated by GitHub Actions - JMeter Performance Testing</p>
        <p>Repository: $repository</p>
    </div>
</body>
</html>
"@
        
        $htmlContent | Out-File -FilePath "email-report.html" -Encoding UTF8
        
        Write-Host "‚úÖ Email report generated"
        Write-Host "================================"
        Write-Host "üìä TEST SUMMARY"
        Write-Host "================================"
        Write-Host "Total Requests: $totalSamples"
        Write-Host "Successful: $successful"
        Write-Host "Failed: $failed"
        Write-Host "Success Rate: $successRate%"
        Write-Host "Avg Response Time: $avgTime ms"
        Write-Host "================================"

    - name: üìß Send Email Report with Artifacts Link
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "${{ env.RP_PROJECT }} Performance Test - Run #${{ github.run_number }}"
        to: ${{ env.RECIPIENT_EMAIL }}
        from: JMeter Bot <${{ secrets.EMAIL_USERNAME }}>
        html_body: file://email-report.html
        priority: normal
        ignore_cert: true
        convert_markdown: false

    - name: üì¶ Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: html-report
        path: html-report/
        retention-days: 30
        if-no-files-found: warn

    - name: üì¶ Upload JTL Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jtl-results
        path: results.jtl
        retention-days: 30
        if-no-files-found: warn

    - name: üì¶ Upload JMeter Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-logs
        path: jmeter.log
        retention-days: 30
        if-no-files-found: warn

    - name: ‚úÖ Print Summary
      if: always()
      shell: pwsh
      run: |
        $workflowUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        $artifactsUrl = "$workflowUrl#artifacts"
        
        Write-Host "================================"
        Write-Host "üìß EMAIL SENT SUCCESSFULLY"
        Write-Host "================================"
        Write-Host "üîó Artifacts URL: $artifactsUrl"
        Write-Host "üîó Workflow URL: $workflowUrl"
        Write-Host ""
        Write-Host "üì¶ Recipients will receive:"
        Write-Host "  - Test summary with metrics"
        Write-Host "  - Direct link to download artifacts"
        Write-Host "  - Instructions for viewing reports"
        Write-Host "================================"
