name: JMeter Performance Test

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  JMETER_VERSION: '5.6.3'
  TEST_PLAN_PATH: 'google-test-.jmx'
  RP_PROJECT: 'google-test-'

jobs:
  performance-test:
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ” List Repository Files
      shell: pwsh
      run: |
        Write-Host "ğŸ“‚ Repository Structure:"
        Get-ChildItem -Recurse | Select-Object FullName
        Write-Host "`nğŸ¯ Looking for test plan at: $env:TEST_PLAN_PATH"
        if (Test-Path $env:TEST_PLAN_PATH) {
            Write-Host "âœ… Test plan found!"
        } else {
            Write-Host "âŒ Test plan NOT found!"
            Write-Host "Current directory: $(Get-Location)"
        }

    - name: â˜• Setup Java 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: ğŸ’¾ Cache JMeter
      id: cache-jmeter
      uses: actions/cache@v3
      with:
        path: apache-jmeter-${{ env.JMETER_VERSION }}
        key: jmeter-${{ env.JMETER_VERSION }}

    - name: ğŸ“¥ Download JMeter
      if: steps.cache-jmeter.outputs.cache-hit != 'true'
      shell: pwsh
      run: |
        Write-Host "ğŸ“¥ Downloading JMeter $env:JMETER_VERSION..."
        $url = "https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-$env:JMETER_VERSION.zip"
        Invoke-WebRequest -Uri $url -OutFile "jmeter.zip"
        
        Write-Host "ğŸ“‚ Extracting JMeter..."
        Expand-Archive -Path jmeter.zip -DestinationPath . -Force
        Remove-Item jmeter.zip
        
        Write-Host "âœ… JMeter ready!"

    - name: ğŸ” Verify JMeter Installation
      shell: pwsh
      run: |
        $jmeterPath = "apache-jmeter-$env:JMETER_VERSION\bin\jmeter.bat"
        if (Test-Path $jmeterPath) {
            Write-Host "âœ… JMeter executable found at: $jmeterPath"
        } else {
            Write-Host "âŒ JMeter executable NOT found!"
            Write-Host "Looking in:"
            Get-ChildItem apache-jmeter-* -Recurse -Filter "jmeter.bat" | Select-Object FullName
        }

    - name: ğŸ§ª Run JMeter Performance Test
      shell: pwsh
      run: |
        $jmeterPath = "apache-jmeter-$env:JMETER_VERSION\bin\jmeter.bat"
        $testPlan = $env:TEST_PLAN_PATH
        
        Write-Host "ğŸš€ Starting Performance Test..."
        Write-Host "JMeter Path: $jmeterPath"
        Write-Host "Test Plan: $testPlan"
        Write-Host "Current Directory: $(Get-Location)"
        
        # ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù…Ù„Ù Ù…ÙˆØ¬ÙˆØ¯
        if (-not (Test-Path $testPlan)) {
            Write-Host "âŒ ERROR: Test plan file not found at: $testPlan"
            Write-Host "Available files:"
            Get-ChildItem -Recurse *.jmx | Select-Object FullName
            exit 1
        }
        
        # ØªØ´ØºÙŠÙ„ JMeter
        Write-Host "`nâ–¶ï¸ Executing JMeter..."
        & $jmeterPath -n -t $testPlan -l results.jtl -e -o html-report -j jmeter.log
        
        $exitCode = $LASTEXITCODE
        Write-Host "`nJMeter Exit Code: $exitCode"
        
        # Ø¹Ø±Ø¶ Ø¢Ø®Ø± 50 Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ù€ log
        if (Test-Path "jmeter.log") {
            Write-Host "`nğŸ“‹ JMeter Log (Last 50 lines):"
            Get-Content "jmeter.log" -Tail 50
        }
        
        # ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„ÙØ§Øª
        Write-Host "`nğŸ“ Checking output files..."
        if (Test-Path "results.jtl") {
            $lines = (Get-Content "results.jtl").Count
            Write-Host "âœ… results.jtl created ($lines lines)"
        } else {
            Write-Host "âŒ results.jtl NOT created"
        }
        
        if (Test-Path "html-report\index.html") {
            Write-Host "âœ… HTML report created"
        } else {
            Write-Host "âŒ HTML report NOT created"
        }
        
        if ($exitCode -ne 0) {
            Write-Host "âš ï¸ JMeter completed with errors (exit code: $exitCode)"
            exit 1
        }
      continue-on-error: false

    - name: ğŸ“Š Generate Test Summary
      if: always()
      shell: pwsh
      run: |
        if (-not (Test-Path "results.jtl")) {
            Write-Host "âŒ No results file found - skipping summary"
            exit 0
        }
        
        $content = Get-Content "results.jtl"
        if ($content.Count -le 1) {
            Write-Host "âš ï¸ Results file is empty or only contains header"
            exit 0
        }
        
        $totalSamples = $content.Count - 1
        
        $results = $content | Select-Object -Skip 1 | ForEach-Object {
            $fields = $_ -split ','
            if ($fields.Count -ge 8) {
                [PSCustomObject]@{
                    Success = $fields[7] -eq 'true'
                    ResponseTime = if ($fields[1]) { [int]$fields[1] } else { 0 }
                }
            }
        }
        
        if ($results.Count -eq 0) {
            Write-Host "âš ï¸ No valid results to parse"
            exit 0
        }
        
        $successful = ($results | Where-Object { $_.Success }).Count
        $failed = ($results | Where-Object { -not $_.Success }).Count
        $avgTime = ($results | Measure-Object -Property ResponseTime -Average).Average
        $maxTime = ($results | Measure-Object -Property ResponseTime -Maximum).Maximum
        $minTime = ($results | Measure-Object -Property ResponseTime -Minimum).Minimum
        
        $summary = @"
        ## ğŸ“Š Performance Test Results
        
        | Metric | Value |
        |--------|-------|
        | ğŸ“ Total Requests | $totalSamples |
        | âœ… Successful | $successful |
        | âŒ Failed | $failed |
        | ğŸ“ˆ Success Rate | $([math]::Round(($successful/$totalSamples)*100, 2))% |
        | â±ï¸ Avg Response Time | $([math]::Round($avgTime, 2)) ms |
        | âš¡ Min Response Time | $minTime ms |
        | ğŸ”¥ Max Response Time | $maxTime ms |
        "@
        
        $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8
        
        Write-Host "================================"
        Write-Host "ğŸ“Š TEST SUMMARY"
        Write-Host "================================"
        Write-Host "Total Requests: $totalSamples"
        Write-Host "Successful: $successful"
        Write-Host "Failed: $failed"
        Write-Host "Success Rate: $([math]::Round(($successful/$totalSamples)*100, 2))%"
        Write-Host "Avg Response Time: $([math]::Round($avgTime, 2)) ms"
        Write-Host "================================"

    - name: ğŸ“¦ Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: html-report
        path: html-report/
        retention-days: 30
        if-no-files-found: warn

    - name: ğŸ“¦ Upload JTL Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jtl-results
        path: results.jtl
        retention-days: 30
        if-no-files-found: warn

    - name: ğŸ“¦ Upload JMeter Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-logs
        path: jmeter.log
        retention-days: 30
        if-no-files-found: warn

    - name: ğŸ’¬ Comment Test Results on PR
      if: always() && github.event_name == 'pull_request' && hashFiles('results.jtl') != ''
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('results.jtl') && fs.existsSync(process.env.GITHUB_STEP_SUMMARY)) {
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
          }
